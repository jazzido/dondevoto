<!doctype html>
<head>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="static/jquery-2.0.3.js"></script>
  <script type="text/javascript" src="static/underscore-min.js"></script>
  <script type="text/javascript" src="static/gmaps.js"></script>
  <link rel="stylesheet" href="static/dondevoto.css" type="text/css" media="screen" />
  <title>dondevoto</title>
</head>
<body>
  <div id="container">
    <label for="distrito">Distrito:</label>
    <select id="distrito">
      {% for p, ds in provincias_distritos.iteritems() %}
      <optgroup label="{{ p.1|e }}">
        {% for id, d, count in ds %}
        <option value="{{p.0}}-{{id}}">{{d}} ({{count}})</option>
        {% endfor %}
      </optgroup>
      {% endfor %}
    </select>
    <div id="map-container">
      <div id="map">
      </div>
    </div>
    <table id="establecimientos">
    </table>
  </div>

  <script type="text/template" id="establecimientos-template">
      <thead>
        <tr>
          <th>Establecimiento</th>
          <th>Direcci√≥n</th>
          <th>Localidad</th>
          <th>Circuito</th>
        </tr>
      </thead>
      <tbody>
        <% _.each(establecimientos, function(e) { console.log(e);%>
        <tr data-establecimiento-id="<%- e.id %>">
          <td><%- e.establecimiento %></td>
          <td><%- e.direccion %></td>
          <td><%- e.localidad %></td>
          <td><%- e.circuito %></td>
        </tr>
        <% }); %>
      </tbody>
  </script>

  <script type="text/javascript">
    $(function(){
        map = new GMaps({
            div: '#map',
            lat: -12.043333,
            lng: -77.028333,
            mapType: google.maps.MapTypeId.HYBRID
        });

        var table_tmpl = _.template($('#establecimientos-template')[0].innerHTML);
        var polygon = null;
        var markers = [];

        $('select#distrito').on('change', function() {
            var p_d = $(this).val().split('-');
            $.get('/establecimientos/' + p_d.join('/'),
                 function(data) {

                     $('table#establecimientos')
                          .html(table_tmpl({establecimientos: data }));
                 });

            map.removeMarkers(markers);
            markers = []

            $.get('/seccion/' + p_d.join('/'), function(data) {
                map.fitLatLngBounds(data.bounds.coordinates[0].map(function(p) {
                    return new google.maps.LatLng(p[1], p[0]);
                }));

                if (polygon != null) map.removePolygon(polygon);

                polygon = map.drawPolygon({
                    paths: data.geojson.coordinates,
                    useGeoJSON: true,
                    strokeOpacity: 0.4,
                    strokeWeight: 1,
                    strokeColor: '#ff0000',
                    fillColor: '#BBD8E9',
                    fillOpacity: 0.4
                });
            });
        });

        var showMarker = function(e) {
            console.log(e);
        };

        $(document).on(
            {
                'click': function() {
                    var eid = $(this).data('establecimiento-id');
                    $.get('/matches/' + eid,
                          function(data) {
                              map.removeMarkers(markers);
                              markers = []
                              data.forEach(function(m) {
                                  var marker = map.addMarker({
                                      lat: m.geojson.coordinates[1],
                                      lng: m.geojson.coordinates[0],
                                      details: m,
                                      infoWindow: {
                                          content: m.nombre
                                      },
                                      click: showMarker,
                                  });
                                  markers.push(marker);
                              });
                              if (markers.length > 0) map.fitZoom();
                          });
                }
            }, 'table#establecimientos tr');

    });
  </script>

</body>
